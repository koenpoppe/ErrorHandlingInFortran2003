# FC=nagfor
# FC=gfortran_beta
FC=gfortran
# FC=ifort_beta

first: library

###############################################################################

LIBDIR=$(FC)$(ALT)_build/
LIBRARY=$(LIBDIR)liberror_handling.a

library: $(LIBDIR) $(LIBRARY)

OBJECTS= \
	error_handling_error.o \
	error_handling_common_errors.o \
	error_handling_common_wrappers.o \
	error_handling_legacy.o \
	design_by_contract.o \
	error_handling_unittest.o \
	error_handling.o

$(LIBDIR):
	mkdir -p -v $(LIBDIR)
$(LIBRARY): $(LIBDIR) $(OBJECTS)
	$(AR) -r -u $@ $(OBJECTS)

veryclean_library:
	$(RM) $(LIBRARY)
	$(RM) -r $(LIBDIR)

###############################################################################

include makefile.inc
# Additional flags
FFLAGS_nagfor+=-mdir $(LIBDIR) -I $(LIBDIR)
FFLAGS_gfortran_beta+=-J $(LIBDIR)
FFLAGS_ifort_beta:= -module $(LIBDIR) $(FFLAGS_ifort_beta)
FFLAGS_gfortran+=-J $(LIBDIR)

FFLAGS=$(FFLAGS_$(FC))
%.o: %.f03
	$(FC) -c $(FFLAGS) $^

###############################################################################
# Autogenerated files
AUTOGENERATED=\
	error_handling_common_wrappers.f03 \
	error_handling_unittest.f03 \
	error_handling_preprocessing.h \
	autogenerated_types.xml \
	autogenerated_types

AUTOGENERATED_DEPS=
autogenerated: $(AUTOGENERATED)

autogenerated_types: autogenerated_types.o
	$(FC) -o $@ $^
autogenerated_types.xml: autogenerated_types
	./autogenerated_types

error_handling_common_wrappers.f03: error_handling_common_wrappers.xsl autogenerated.xsl error_handling_common_wrappers.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_common_wrappers.xsl autogenerated.xsl error_handling_common_wrappers.xml
error_handling_unittest.f03: error_handling_unittest.xsl autogenerated.xsl error_handling_unittest.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_unittest.xsl autogenerated.xsl error_handling_unittest.xml
error_handling_preprocessing.h: error_handling_preprocessing.xsl autogenerated.xsl error_handling_unittest.xml autogenerated_types.xml
	xsltproc --output "$@" --stringparam isoD `date +"%Y%m%d"` --debug error_handling_preprocessing.xsl autogenerated.xsl error_handling_unittest.xml

clean_autogenerated:
	$(RM) $(AUTOGENERATED)

###############################################################################
# Create a default autogenerated version
default:
	@touch autogenerated_types.o autogenerated_types
	@cp -v autogenerated_types.default.xml autogenerated_types.xml
	@$(MAKE) --no-print-directory \
		error_handling_common_wrappers.f03 error_handling_unittest.f03 error_handling_preprocessing.h
	$(RM) autogenerated_types.o autogenerated_types autogenerated_types.xml

###############################################################################

clean:
	$(RM) *.o *.mod *.g90

veryclean: clean_autogenerated clean veryclean_library

all: 
	make FC=nagfor veryclean library
	make FC=ifort_beta veryclean library
	make FC=gfortran_beta veryclean library
